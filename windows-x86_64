# PowerShell Script to Install Elastic Agent 9.1.3 in Current Directory on Windows

# Check if required arguments are provided
param (
    [Parameter(Mandatory=$true)][string]$fleeturl,
    [Parameter(Mandatory=$true)][string]$enrollment-token
)

# Variables
$elasticAgentVersion = "9.1.3"
$caCrtUrl = "https://raw.githubusercontent.com/CyberOpsLab/ic-es-agent/refs/heads/main/windows-x86_64"
$elasticAgentUrl = "https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-$elasticAgentVersion-windows-x86_64.zip"
$downloadPath = ".\elastic-agent-$elasticAgentVersion-windows-x86_64.zip"
$extractDir = ".\elastic-agent-$elasticAgentVersion"
$installPath = "C:\Program Files\Elastic\Agent"

# Get the absolute path of the current directory
$currentDir = Get-Location
$certPath = Join-Path -Path $currentDir -ChildPath "elastic-agent-$elasticAgentVersion\ca.crt"

# Download Elastic Agent to current directory
Write-Host "Downloading Elastic Agent $elasticAgentVersion to $downloadPath..."
Invoke-WebRequest -Uri $elasticAgentUrl -OutFile $downloadPath
if (-not (Test-Path $downloadPath)) {
    Write-Host "Error: Failed to download Elastic Agent."
    exit 1
}

# Extract the downloaded zip
Write-Host "Extracting Elastic Agent to $extractDir..."
Expand-Archive -Path $downloadPath -DestinationPath $extractDir -Force

# Download CA certificate
Write-Host "Downloading CA certificate to $certPath..."
Invoke-WebRequest -Uri $caCrtUrl -OutFile $certPath
if (-not (Test-Path $certPath)) {
    Write-Host "Error: Failed to download CA certificate."
    exit 1
}

# Move to installation directory
Move-Item -Path "$extractDir\elastic-agent-$elasticAgentVersion-windows-x86_64\*" -Destination $installPath -Force

# Change to the installation directory
Set-Location -Path $installPath

# Install Elastic Agent with absolute certificate path
Write-Host "Installing Elastic Agent..."
.\elastic-agent.exe install --url=$fleeturl --enrollment-token=$enrollment-token --certificate-authorities=$certPath

Write-Host "Elastic Agent installation completed in $installPath."
